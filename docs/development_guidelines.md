# Руководство по разработке

## Система табов (вкладок)

### Архитектура

Проект использует две системы табов:
1. **Простые табы** (`simple-tabs.js`) - для верхнего уровня без анимации слайдов
2. **Swiper-табы** (`tabs.js`) - для дочерних табов с поддержкой autoHeight

### Простые табы (Simple Tabs)

#### Назначение

Используются для переключения контента верхнего уровня (например, переключатель паков дизайна), где не требуется анимация слайдов и autoHeight. Обеспечивают мгновенное переключение без задержек синхронизации высоты.

#### Техническая реализация

- **Файлы**: `src/js/simple-tabs.js`, `src/css/simple-tabs.css`
- **Принцип работы**: Простое показ/скрытие контента через классы `hidden`/`active`
- **Селекторы**:
  - `.simple-tab-group` - контейнер группы табов
  - `.simple-tab-buttons` - контейнер кнопок
  - `.simple-tab-btn` - кнопка таба
  - `.simple-tab-content` - панель контента
- **Стилизация**: Используются существующие классы `.material-tab` для визуального оформления кнопок

#### Структура компонента

```html
<div class="simple-tab-group">
    <div class="simple-tab-buttons material-tabs">
        <button class="simple-tab-btn material-tab active">Таб 1</button>
        <button class="simple-tab-btn material-tab">Таб 2</button>
    </div>
    <div class="simple-tab-content">
        <!-- Контент первого таба -->
    </div>
    <div class="simple-tab-content">
        <!-- Контент второго таба -->
    </div>
</div>
```

### Swiper-табы (для вложенного контента)

#### Назначение

Используются для дочерних табов, где требуется автоматическая подстройка высоты (например, переключатель форматов баннеров внутри пака).

#### Техническая реализация

- **Файл**: `src/js/tabs.js`
- **Принцип изоляции**: Используются CSS-селекторы с комбинатором прямого потомка (`:scope >`)
  - `:scope > .tab-swiper` - находит swiper только как прямого потомка текущей группы
  - `:scope > .tab-buttons > .tab-btn` - находит кнопки только как прямых потомков `.tab-buttons` текущей группы
- **Преимущества**:
  - Автоматическая подстройка высоты контента (`autoHeight: true`)
  - Плавные переходы между слайдами
  - Изоляция вложенных групп табов

#### Структура компонента

```html
<div class="tab-group">
    <div class="tab-buttons">
        <button class="tab-btn">Таб 1</button>
        <button class="tab-btn">Таб 2</button>
    </div>
    <div class="swiper tab-swiper">
        <div class="swiper-wrapper">
            <div class="swiper-slide">
                <!-- Может содержать вложенную tab-group -->
            </div>
        </div>
    </div>
</div>
```

#### Пример использования в проекте

В `view.html` используется комбинированная структура:
1. **Простые табы** - "Пак 1/Пак 2/Пак 3" (переключатель паков дизайна)
2. **Swiper-табы** - "240×400/320×480/Видео/HTML5" (переключатель форматов баннеров внутри каждого пака)

Такая архитектура решает проблему синхронизации высоты между уровнями - простые табы мгновенно переключаются, а swiper-табы автоматически подстраивают высоту под свой контент.

#### Стили табов

- **Material Design табы**: класс `.material-tab` - используется для основных разделов
- **Viewer табы**: класс `.viewer__tab` - используется для форматов контента
- Классы стилизации можно применять к любому типу табов (простым или swiper)

## Фильтры проектов

### Область применения

Вся логика фильтров применяется **только к элементам внутри `#project-filter-form`**. Это обеспечивает изоляцию от других фильтров на сайте (например, фильтр годов на странице статистики).

### Поиск в фильтрах

#### Архитектура

Фильтры имеют встроенную функциональность поиска через поля `.filter-search__input` внутри `#project-filter-form`. Каждое поле поиска работает независимо для своего блока фильтров.

#### Логика работы

1. **Управление позициями активных элементов**: Пункты с классом `.filter__item_active` управляются автоматически:
   - **При инициализации**: активные элементы перемещаются в начало списка
   - **При выборе элемента**: элемент перемещается в начало списка **с задержкой 300мс** (плавный эффект)
   - **При снятии выделения**: элемент **мгновенно** возвращается на свою исходную позицию в списке
   - **При фильтрации**: активные элементы всегда в начале результатов
   - **При восстановлении после фильтрации**: активные элементы остаются в начале

2. **Фильтрация по тексту**: При вводе текста в поле поиска выполняется фильтрация пунктов фильтра (`.filter__item`) по частичному совпадению с текстом пункта (регистронезависимый поиск).

3. **Активная фильтрация** (когда введён текст в поле):
   - **Все найденные элементы** показываются без ограничений по количеству
   - **Активные элементы** всегда видимы и расположены в начале списка
   - Элементы, не соответствующие поисковому запросу, скрываются
   - Кнопки expand/collapse **скрыты** во время фильтрации

4. **Восстановление состояния** (при очистке поля поиска):
   - Восстанавливается **состояние видимости, которое было до начала фильтрации**
   - **Активные элементы остаются в начале списка**
   - Кнопки expand/collapse восстанавливают своё состояние (раскрыт/свернут), которое было до фильтрации
   - Кнопка expand возвращается на исходную позицию
   - Текст кнопки expand восстанавливается к исходному значению
   - **Важно**: Если список был раскрыт до фильтрации, он останется раскрытым после очистки фильтра

#### Управление состоянием

**1. Исходные позиции элементов** (сохраняются при первом вызове функцией `setupItemPositions`):
- Исходная позиция каждого элемента фильтра в DOM (parent и nextSibling) - **сохраняется ДО любых перемещений**
- Функция `setupItemPositions` вызывается только один раз для каждого контейнера (повторные вызовы возвращают кешированные данные)
- Исходная позиция кнопки expand в DOM-дереве
- Исходный текст кнопки expand (например, "+6")

**2. Состояние до фильтрации** (сохраняется при начале ввода текста):
- Текущее состояние видимости всех пунктов на момент начала фильтрации
- Состояние кнопок expand/collapse (видима/скрыта)

**3. Логика перемещения элементов:**
- **При добавлении active**: элемент перемещается наверх через `moveActiveItemsToTop()` с задержкой **300мс**
- **При удалении active**: элемент **мгновенно** возвращается на исходную позицию через `restoreItemPosition(item)`, затем оставшиеся активные перемещаются наверх

**Пример сценария работы с активными элементами:**
1. Фильтр "Площадки": элементы в порядке [Все, Рамблер, Яндекс, Instagram, Avito...]
2. Пользователь выбирает "Яндекс" → **через 300мс** элемент плавно перемещается наверх: [Яндекс, Все, Рамблер, Instagram, Avito...]
3. Пользователь выбирает "Avito" → **через 300мс** элемент плавно перемещается наверх: [Avito, Яндекс, Все, Рамблер, Instagram...]
4. Пользователь снимает выделение с "Яндекс" → элемент **мгновенно** возвращается на позицию 3: [Avito, Все, Рамблер, Яндекс, Instagram...]
5. **Результат**: активный "Avito" остался вверху, "Яндекс" вернулся на своё место

**Пример сценария с фильтрацией:**
1. Пользователь открывает фильтр "Тип материала" (показано 10 элементов, остальные скрыты)
2. Нажимает кнопку "+6" (список раскрывается, показаны все элементы)
3. Начинает вводить "HTML" в поле поиска → сохраняется текущее состояние (все элементы видны)
4. Показываются только элементы с "HTML" в названии (активные всегда наверху)
5. Пользователь очищает поле поиска
6. **Результат**: список остается раскрытым, активные элементы остаются в начале списка

#### Пример использования

```html
<div class="filter">
    <div class="filter__header">
        <p class="filter__name">Площадки</p>
        <div class="filter-search">
            <span class="filter-search__icon">
                <i class="icon icon-search"></i>
            </span>
            <input type="search" placeholder="Поиск" class="filter-search__input" />
        </div>
    </div>
    <div class="filter__items">
        <a href="#" class="filter__item filter__item_active">Яндекс</a>
        <a href="#" class="filter__item">Google</a>
        <!-- ... другие пункты ... -->
    </div>
</div>
```

#### Техническая реализация

- **Файл**: `src/js/filters.js`
- **Область действия**: все селекторы работают только внутри `#project-filter-form`
  - `#project-filter-form .filter__items` - блоки с элементами фильтров
  - `#project-filter-form .filter-search__input` - поля поиска
- **Главная функция**: `setupItemPositions(container)` - инициализирует управление позициями элементов фильтра:
  - **Кеширование**: проверяет флаг `container._positionsInitialized` и возвращает кешированные данные при повторном вызове
  - Сохраняет исходные позиции всех элементов в `Map` **ДО любых перемещений**
  - Возвращает функции `moveActiveItemsToTop()` и `restoreItemPosition(item)`
  - Настраивает обработчики кликов для отслеживания изменений состояния active
  - Сохраняет результат в `container._positionsData` для повторного использования
- **Функция перемещения**: `moveActiveItemsToTop()` - перемещает все активные элементы в начало списка
- **Функция восстановления**: `restoreItemPosition(item)` - возвращает элемент на исходную позицию в DOM
- **Обработчик поиска**: `input` event на `#project-filter-form .filter-search__input`
- **Обработчик кликов**: `click` event на `.filter__item`:
  - Сохраняет состояние `wasActive` перед обработкой клика
  - После задержки 10ms проверяет новое состояние
  - Если стал неактивным → мгновенно восстанавливает позицию
  - Если стал активным → перемещает наверх с задержкой **300мс** (для визуального эффекта)
- **Хранение состояния**: `Map` для позиций элементов и состояния фильтрации
- **Фильтрация**: через `textContent.toLowerCase().includes(searchTerm)`
